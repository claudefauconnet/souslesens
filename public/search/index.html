<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search</title>
    <link rel="stylesheet" type="text/css" href="list.css"/>
    <style>
        body {
            font-family: verdana, sans-serif;
            font-size: 12px;
            height: 100%;
            padding: 0;
            margin: 0;
            display: -webkit-box;
            display: -moz-box;
            display: -ms-flexbox;
            display: -webkit-flex;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        em, .em {
            background-color: #dad55e;
        }

        .wordEm {
            background-color: #f8893f;
        }

        em2 {
            background-color: #777620;
        }

        .title {
            font-weight: bold;
            color: blue;

        }

        #searchInput {
            height: 20px;
            width: 300px;
            font-size: 18px;
            font-weight: normal;
        }

        .path {
            color: blue;
        }

        .date {
            font-style: italic;
        }

        #panels {

        / / display: inline-table;
            margin-top: 30px;
            display: inline-flex;
        }

        #leftPanel {
            width: 200px;
            float: left;
            overflow-y: auto;
            font-size: 12px;

        }

        #centerPanel {
            width: 600px;
        / / float: left;
            display: table;
            overflow-y: auto;
            font-size: 12px;
            justify-content: center;

        }

        #resultDiv {
            width: 600px;
        }

        #rightPanel {
            width: 200px;
            float: left;

            overflow-y: auto;
            font-size: 10px;

        }

        #dialogContentDiv {
            width: 820px;
            height: 560px;
            margin-left: 10px;
            overflow: auto;
            background-color: white;
            font-size: 12px;
            font-weight: normal;
        }

        .highlight {
            font-size: 10px;
        }

        #top {
            font-size: 14px;
            font-weight: normal;

        }

        .rightPanelTd {
            visibility: hidden;
        }

        #dialog {
            /*   position: absolute;
               top:200px;
               left:300px;*/
            display: block;
            align: center;
            position: absolute;
            height: 650px;
            width: 850px;
            top: 100px;
            left: 300px;
            background-color: whitesmoke;
            visibility: hidden;
            border: #0a6aa1;
            border-style: groove;
        }

        #associatedWordsBreadcrumbDiv {
            font-style: italic;
            font-weight: bold;
            color: brown;
        }

        img {
            vertical-align: middle;
        }

        a:link, a:visited, a:hover, a:active {
            text-decoration: none;
            color: #261803;

        }

        #top {
            font-size: 14px;
        }

        #conceptDiv, #typesDiv, #associatedWordsDiv, #sourcesDiv {
            width: 200px;
        / / height: 250 px;
            overflow: auto;
            background-color: #eaeaea;
        }

        #graphDiv {
            width: 600px;
            height: 500px;
        / / background-color: #93aeca;
        }

        .docListResult {
            background: #93aeca;
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            min-width: 400px;
        }

        .docContentFields {

            border-style: solid;
            background-color: #CCCCCC;
            table-border-color-light: #261803;

        }
        .indexCbxButton{
            margin: 1px;
            padding: 1px;
            font-size: 10px;
        }

        li {
            margin-left: 10px;
        }

        .subQuerySpan, .searchInput {
            margin: 5px;
        }

        .currentPageLink {
            font-weight: bold;
        }

        /*  .jstree-classic li[rel="Role"] > a {

              font-family: "sans-serif Verdana";
              font-size: 10px;
          }*/
    </style>

    <script src="../../common/js/jquery/jquery.min.js"></script>
    <script src="../../common/js/jquery/jquery-ui.min.js"></script>
    <script src="../../common/js/jsTree/jstree.min.js"></script>
    <script src="../../common/js/common.js"></script>
    <script src="../../common/js/jsTreeController.js"></script>
    <script src="../../common/js/connectors.js"></script>

    <script src="../toutlesens/js/visjs/visjs.js"></script>
    <script src="../toutlesens/js/visjs/visJsGraph.js"></script>


    <link rel="stylesheet" href="../../common/js/jsTree/themes/default/style.min.css"/>
    <script>
        var elasticUrl = "../../../elastic";
        var authenticationUrl = "../../../authentication";
        var associatedWords = [];
        var oldWord = "";
        var currentClassifierData = [];
        var from0 = 0;
        var currentPage = 1;
        var currentDocId;
        var currentType = null;
        var currentAssociatedDocIds;
        var icons = {};
        var mode = "";
        var fetchSize = 10;
        var maxCsvSize = 10000;
        var currentDocHighlightIndex = 0;
        var currentDocFindWordIndex = 0
        var dialogContentDivScroll = 0

        var queryAssociatedWords = true;
        var showClassifiersDiv = false;
        var currentFindWord = {str: "", p: 0};
        var userIndexes = [];


        $(function () {

            setUserIndexes();
            totalWidth = $(window).width();
            totalHeight = $(window).height();
            // $("#centerPanel").width(Math.max(totalWidth - 500, 500));

            var resultDivWidth = $("#resultDiv").width();
            var leftPanelWidth = $("#leftPanel").width();


            $("#centerPanel").height(totalHeight);
            $("#leftPanel").height(totalHeight);
            $("#rightPanel").height(totalHeight);
            // $("#rightPanel").css("left", 1000)
            $("#dialog").css("left", ((totalWidth) / 2) - 400)
            $("#slopSpan").css("visibility", "hidden");
            $("#showMongoFormInput").css("visibility", "hidden");
            $("#resultDiv").height(totalHeight - 150).css("overflow", "auto");

            $("#subQuerySpan").css("visibility", "hidden")
            $("#searchInput").focus();

            if (showClassifiersDiv)
                $("#classifiersDiv").css("visibility", "visible");
            else
                $("#classifiersDiv").css("visibility", "hidden");


            if (queryParams.index && queryParams.index.toLowerCase() != "_all") {
                $("#indexInput").val(queryParams.index);

                var payload = {
                    getMappingsFields: 1,
                    index: queryParams.index,
                };

                $.ajax({
                    type: "POST",
                    url: elasticUrl,
                    data: payload,
                    dataType: "json",
                    success: function (data, textStatus, jqXHR) {
                        if (data.length > 0) {
                            data.splice(0, 0, "");
                            common.fillSelectOptionsWithStringArray(queryFieldSelect, data);
                            $("#queryFieldSpan").css("visibility", "visible")
                        } else {
                            $("#queryFieldSpan").css("visibility", "hidden")
                        }

                    }
                })
            }
            if (queryParams.index == "archivesatd") {
                $("#showMongoFormInput").css("visibility", "visible");
            }

            $("#searchInput").keyup(function () {
                var val = $(this).val();
                if (val.length > 2)
                    $("#plusSpan").css("visibility", "visible")

                var p = val.indexOf(" ");
                if (p > 0 && p < (val.length - 1) && val.indexOf("*") < 0) {
                    $("#slopSpan").css("visibility", "visible")
                    $("#slopInput").val("3")
                    $("#slopInput").css("visibility", "visible");
                }
                else {
                    $("#slopInput").css("visibility", "hidden");
                    $("#slopInput").val("")
                    $("#slopSpan").css("visibility", "hidden")
                }

            });


            /*  $("#dialog").dialog({
             autoOpen: false,
             height: "650px",
             width: "850px",
             modal: true,



             });*/

            document.getElementById("searchInput").focus();
            $("#dialog").on("blur", function () {
                $("#dialog").css("visibility", "hidden")
            });


            if (false) {

                $("#loginDiv").css("visibility", "visible");
                $("#panels").css("visibility", "hidden");

            }
        })

        function doLogin() {
            var payload = {
                authentify: 1,
                login: $("#loginInput").val(),
                password: $("#passwordInput").val()
            }
            $.ajax({
                type: "POST",
                url: authenticationUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    $("#loginDiv").css("visibility", "hidden");
                    $("#panels").css("visibility", "visible");
                    $("#searchInput").focus();


                }, error: function (err) {
                    $("#loginMessage").html("invalid  login or password");

                }
            })

        }

        function setUserIndexes() {
            var user = "Claude";
            var payload = {
                getUserIndexes: 1,
                user: user
            }
            $.ajax({
                type: "POST",
                url: elasticUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var x = data;
                    data.sort();
                    var indexesCxbs = "<ul>";

                    for (var i = 0; i < data.length; i++) {

                        indexesCxbs += "<li><input type='checkbox' checked='checked' onchange='search()' name='indexesCbxes' value='" + data[i] + "'><span id='indexCbxSpan_" + data[i] + "'>" + data[i] + "</span></li>"
                    }
                    indexesCxbs += "<ul>";
                    $("#sourcesDiv").html(indexesCxbs);

                }, error: function (e) {
                }

            })
        }

        function search(_from, pageIncrement, page, callback) {


            var from;
            if (!_from) {
                from = 0;
                currentPage = 1
            }
            else {
                from = _from;
                if (page)
                    currentPage = page;
                if (pageIncrement)
                    currentPage += pageIncrement;
            }

            $("#dialog").css("visibility", "hidden")

            //  $("#subQuerySpan").css("visibility", "visible")
            //  $("#addWordInput").val("");


            $("#conceptDiv").html("");
            $("#countDiv").html("");
            $("#resultDiv").html("");
            $("#associatedWordsDiv").html("");

            var indexes = "";
            var i = 0;
            $('[name=indexesCbxes]:checked').each(function () {
                if (i++ > 0)
                    indexes += ",";
                indexes += ($(this).val());
            });


            var index = $("#indexInput").val();
            var word = $("#searchInput").val().trim();
            var booleanSearchMode = $("#booleanSearchSelect").val();

            var addWordInput = $("#addWordInput").val();

            if (addWordInput && addWordInput.length > 0) {
                addAssociatedWord(addWordInput, true);

                //  associatedWords.push(addWordInput);

            }
            //   $("#addWordInput").val("")

            if (word != oldWord) {
                associatedWords = []
            }
            oldWord = word;
            var slop = $("#slopInput").val();

            if (slop != "" && word.indexOf(" ") > 0 && word.indexOf("*") > 0) {

                $("#resultDiv").html("Impossible to have a query with this pattern : xxx* yyy and a distance between the two words. remove * or set distance to 0");
                return;
            }


            var classifierSourceStr = $("#classifierSource").val();

            var size = fetchSize;
            if (callback || isFieldQuery()) {
                size = maxCsvSize;
            }
            var payload = {
                findDocuments: 1,
                options: {
                    from: from,
                    size: size,
                    indexName: indexes,
                    word: word,
                    booleanSearchMode: booleanSearchMode,
                    getAssociatedWords: {
                        indexName: index,
                        word: associatedWords,
                        size: 100,
                        options: {
                            iterations: 5,
                            classifierSource: classifierSourceStr
                        }
                    }
                }
            };
            if (currentType)
                payload.options.type = currentType
            if (slop != "")
                payload.options.slop = parseInt(slop);
            if (associatedWords.length > 0)
                payload.options.andWords = associatedWords;

            var queryField = $("#queryFieldSelect").val();
            if (queryField != "") {
                payload.options.queryField = queryField;
            } else {
                $("#queryFieldSpan").css("visibility", "hidden");
            }

            $.ajax({
                type: "POST",
                url: elasticUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    $("#infos").css("visibility", "visible");
                    $(".rightPanelTd").css("visibility", "visible");
                    $("#clearSearchInputsImg").css("visibility", "visible");

                    if (callback) {
                        return callback(null, data)
                    }
                    icons = {};//data.icons;

                    if (isFieldQuery()) {
                        var visData = connectors.elasticSkosToVisjs(data.docs);
                        visjsGraph.draw("graphDiv", visData);
                        //  showResults(data.docs);
                    } else {
                        showResults(data.docs);
                        showPageControls(data.total);
                        if (associatedWords) {
                            showAssociatedWords(data.associatedWords.buckets);
                            showIndexesStats(data.stats);
                            showTypes(data.associatedWords.types);
                            showClassifier(data.associatedWords.classifier);
                        }
                    }

                }
                , error: function (xhr, err, msg) {
                    if (callback) {
                        return callback(err)
                    }
                    return (err);
                }

            });

        }


        function showResults(data) {

            if (data.length == 0) {
                $("#resultDiv").html(" No result   Try to add an * (wildcard) at the end of the word")

                return;
            }
            var html = "<table>";


            for (var i = 0; i < data.length; i++) {
                html += "<tr>";
                html += "<td>";
                html += getListDisplayHtml(data[i]);

                html += "</tr>";
                html += "</td>";
            }
            html += "</table>";


            $("#resultDiv").html(html);
        }

        function showPageControls(total) {
            var maxPagesLinks = 10;
            $("#countDiv").html(total + " documents found");
            if (total > fetchSize) {

                var str = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages ";
                var k = 1

                str += "<a href='javascript:search(" + currentPage * fetchSize + ",1)'> next  </a>&nbsp;&nbsp;";
                if (currentPage > 1)
                    str += "<a href='javascript:search(" + (currentPage - 1) * fetchSize + ",-1)'> previous  </a>&nbsp;&nbsp;";


                for (var i = 1; i < total; i++) {
                    var linkClass = "";
                    if (k == currentPage)
                        linkClass = " class='currentPageLink' ";


                    if (i % fetchSize == 0) {
                        str += "<a " + linkClass + "href='javascript:search(" + (k - 1) * fetchSize + ",0," + k + ")'>" + k + "</a>&nbsp;&nbsp;"
                        k++;
                    }

                    /*  if (currentPage > 1) {
                     str += "<a href='javascript:search(" + 0 + ",1)'>...first  </a>&nbsp;&nbsp;";

                     }*/

                    if (i > maxPagesLinks * fetchSize) {
                        str += "...";
                        // str += "<a href='javascript:search(" +Math.round(total/fetchSize)*fetchSize + ")'>... first </a>&nbsp;&nbsp;";
                        break;
                    }
                }


                $("#pages").html(str)
            }
        }


        function showAssociatedWords(data) {
            if (!data)
                return;
            var html = "<ul>"
            data.sort(function (a, b) {
                if (a.count > b.count)
                    return -1;
                if (a.count < b.count)
                    return 1;
                return 0
            })
            for (var i = 0; i < data.length; i++) {
                if (data[i].key.length > 3)
                    html += "<li>" + "<a href='javascript:addAssociatedWord(\"" + data[i].key + "\")'>" + data[i].key + " (" + data[i].count + ")</a></li>"
            }
            html += "</ul>";
            $("#leftPanel").css("visibility", "visible");
            $("#associatedWordsDiv").html(html);

        }

        function getListDisplayHtml(obj) {


            if (isFieldQuery()) {
                return JSON.stringify(obj);
            }

            var str = "<div class='docListResult'>";
            if (icons["docTypes"] && icons["docTypes"][obj.type])
                str += "<img  src='./icons/" + icons["docTypes"][obj.type] + "'>";

            str += "<img style='border-style: solid;border-color: #0000cc;border-width: 1px;border-radius: 8px' title='pre-visualize' onclick='visualizeDocContent(\"" + obj._id + "\",\"" + obj._index + "\")' src='./icons/details.png' width='20px'> </a>&nbsp;&nbsp;&nbsp;";
            str += "<i>" + obj._index + "</i>&nbsp;";
            if (obj.path) {
                var path = decodeURIComponent(obj.path)
                var p = path.lastIndexOf("/");
                if (p < 0)
                    p = path.lastIndexOf("\\");
                if (p > -1)
                    path = path.substring(p + 1)
                str += "<span class=title>" + path + "</span>"
            }
            else if (obj.title) {
                str += "<span class=title>" + obj.title + "</span>"
            }
            else
                str += "<span class=title>" + obj[0] + "</span>"

            if (obj.date) {
                if (obj.date.length > 10)
                    obj.date = obj.date.substring(0, 10);
                str += "&nbsp;&nbsp;" + obj.date + "&nbsp;&nbsp;";
            }
            if (obj.path) {

                var path = decodeURIComponent(obj.path)
                //  str +=  "<a href='file://"+path+"' > doc</a>";
                //  str += "<img  title='load document' onclick='getOriginalDocument(\"" + obj.path + "\")' src='./icons/document.png' width='20px'> </a>";

            }

            //   str += "<img title='go to document' onclick='getOriginalDocument(\"" + obj.path + "\")' src='document.png' width='15px'> </a><br>";
            // str += "<span class=path>" + obj.path + "</span><br>";

            str += "<ul>";
            for (var i = 0; i < obj.highlights.length; i++) {
                if (i % 2 == 0)
                    str += "<li><span class=highlight>" + obj.highlights[i] + "</span>";
                else {
                    str += " .... <span class=highlight>" + obj.highlights[i] + "</span>";
                    str += "</li>"
                }

            }
            str += "</ul>";
            str += "<div>"
            return str;
        }

        /* function addWordToQuery() {

             var word = $("#addWordInput").val();
             if (word.length > 0)

                 $("#slopInput").val("")
             if ($("#booleanSearchMode").val() == "and") {
                 addAssociatedWord(word);

             }
             else {
                 $("#searchInput").val($("#searchInput").val() + " " + word)
                 $("#slopInput").val("")
                 $("#slopInput").css("visibility", "hidden")
                 search();
             }
         }*/


        function addAssociatedWord(word, dontSearch) {
            associatedWords.push(word);
            showAssociatedWordsBreadcrumb();
            if (!dontSearch)
                search();


        }


        function showAssociatedWordsBreadcrumb() {
            var str = "";
            for (var i = 0; i < associatedWords.length; i++) {
                str += "<a href='javascript:removeAssociatedWord(" + i + ")'>" + associatedWords[i] + "</a>&nbsp;";
            }
            $("#associatedWordsBreadcrumbDiv").html(str)

        }

        function removeAssociatedWord(index) {
            if (associatedWords[index] == $("#addWordInput").val()) {
                $("#addWordInput").val("")
            }
            associatedWords.splice(index, 1);
            showAssociatedWordsBreadcrumb();
            search();
        }

        function showClassifier(data) {

            /*   $('#rightPanel').html("<br><br><br><br><br><br><br><br>Concepts associes<br><br> <div id='conceptDiv'></div>")*/
            currentClassifierData = data


            jsTreeController.load(data, 'conceptDiv', function (node) {

                if (node.children.length > 0) {
                    for (var i = 0; i < currentClassifierData.length; i++) {
                        if (currentClassifierData[i].text == node.text) {
                            for (var j = 0; j < currentClassifierData[i].children.length; j++) {
                                addAssociatedWord(currentClassifierData[i].children[j].word);
                            }
                        }
                    }
                } else {
                    var word = node.original.word;

                    addAssociatedWord(word);
                }


            });


        }

        function showTypes(types) {
            if (!types)
                return;
            //  var str="<select onclick='onTypeClick(this)' size='"+(types.length+1)+"'><option></option>";
            var str = "<ul><li onclick=onTypeClick('')>all types</li>";
            for (var i = 0; i < types.length; i++) {
                str += "<li onclick=onTypeClick('" + types[i] + "')>" + types[i] + "</li>";
            }
            str += "</ul>";
            $("#typesDiv").html(str);
        }

        function onTypeClick(type) {
            //  var type=$(select).val();
            if (type && type.length > 0) {
                currentType = type;
            }
            else
                currentType = null;
            search();
        }


        function visualizeDocContent(id, index) {
            $("#dialogLeftDiv").html("");

            currentDocId = id;
            //   var index = $("#indexInput").val();
            var words = associatedWords;
            var word = $("#searchInput").val()
            if (words.indexOf(word) < 0)
                words.push(word);

            var payload = {
                findDocumentsById: 1,
                indexName: index,
                ids: [id],
                words: words
            };

            console.log(JSON.stringify(payload, null, 2))
            $.ajax({
                type: "POST",
                url: elasticUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    currentDocHighlightIndex = 0;
                    currentDocFindWordIndex = 100;
                    dialogContentDivScroll = 0;
                    $("#scrollToHighlightUpButton").css("visibility", "hidden");
                    words.pop(word);
                    if (data.docs && data.docs.length > 0) {
                        var doc = data.docs[0];


                        for (var i = 0; i < doc.highlights.length; i++) {
                            var highlight = doc.highlights[i];
                            var highlight2 = highlight.replace(/<em>/g, "");
                            highlight2 = highlight2.replace(/<\/em>/g, "");
                            highlight = highlight.replace(/<em>/g, "<b>");
                            highlight = highlight.replace(/<\/em>/g, "</b>");
                            var p = doc.content.indexOf(highlight2);
                            if (p > -1) {

                                //   doc.content=doc.content.substring(0,p)+"<em>"+doc.content.substring(p+1,p+1+highlight.length)+"</em>"+doc.content.substring(p+1)
                                doc.content = doc.content.substring(0, p) + "<em id='em_" + i + "'>" + highlight + "</em>" + doc.content.substring(p + 1 + highlight.length)
                            }

                        }
                        var html = "<b>source</b>: " + doc._index + "&nbsp;";
                        html += "<b>title</b>: " + doc.title + "<br>";
                        html += "<table  class='docContentFields'>";
                        var excludedKeys = ["highlights", "content", "title", "_id", "_index", "type"]

                        for (var key in doc) {
                            if (excludedKeys.indexOf(key) == -1) {

                                if (key == "path") {
                                    doc[key] = decodeURIComponent(doc[key]);
                                    doc[key] = "<a href='" + doc[key] + "'>" + doc[key] + "</a>";
                                }
                                html += "<tr><td style='background-color: #999999'>" + key + "</td><td>" + doc[key] + "</td></tr>"
                            }
                        }


                        html += "</table>";
                        html += doc._id;
                        html += doc.content.replace(/[\n\r]/g, "<br>");

                        /*    mode = data.mode[doc.type];
                            if (mode && mode.source == "MongoDB") {
                                var str = "<button onclick=editMongoForm('" + doc.mongoId + "','" + doc._id + "')>Edit</button>"
                                $("#dialogLeftDiv").append(str);
                                $("#dialogLeftDiv").css("visibility", "visible");
                            }*/

                        $("#dialogContentDiv").html(html);
                        $("#dialog").css("visibility", "visible");


                    }

                }
                , error: function (xhr, err, msg) {
                    words.pop(word);
                    return (err);
                }

            })


        }

        function getOriginalDocument(path) {

            var path = decodeURIComponent(path)
            console.log(path)

            $("#originalDocIframe").attr("src", "file:///+" + path);
            return;
            /*   $("#dialogContentDiv").html("<iframe width='500' height='500' src='file:///+"+path+"'>")
               $("#dialog").css("visibility", "visible");*/
            //   window.location.href = "file:///" + path;

            var payload = {
                getOriginalDocument: 1,
                docRemotePath: path
            }
            $.ajax({
                type: "POST",
                url: elasticUrl,
                data: payload,
                // dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    console.log("getOriginalDocument ok");
                    $("#dialogContentDiv").html(data);
                    $("#dialog").css("visibility", "visible");
                }
                , error: function (xhr, err, msg) {
                    console.log(xhr);
                    return (err);
                }
            });


        }

        function editMongoContent(id) {
            $("#dialogContentDiv").html(html);
            $("#dialog").css("visibility", "visible");
        }


        function admin() {
            var html = "<button onclick='saveClassifier()'>save</button><br></button><div id='adminClassifierTree'></div>";
            $("#dialogContentDiv").html(html);
            $("#dialog").css("visibility", "visible");
            /*       adminClassifierTree.load(data, 'conceptDiv', function (functionName, data) {
             if (functionName == "addAssociatedWord")
             addAssociatedWord(data);

             });*/
        }

        function findSimilarDocuments() {
            var index = $("#indexInput").val();
            var payload = {
                findSimilarDocuments: 1,
                indexName: index,
                docId: currentDocId,
                minScore: 3,
                size: 100
            };


            $.ajax({
                type: "POST",
                url: elasticUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var ids = [];
                    var html = "<table border='1'><tr><td>score</td><td>title</td><td>content</td></tr>";
                    for (var i = 0; i < data.length; i++) {
                        ids.push(data[i]._id);
                        var title = data[i].title;
                        var content = data[i].content;
                        var score = data[i]._score;
                        html += "<tr>";
                        html += "<td>" + score + "</td><td>" + title + "</td><td>" + content + "</td>";
                        html += "</tr>";
                    }
                    currentAssociatedDocIds = ids;
                    html += "</table>";
                    $("#dialogContentDiv").html(html);

                    if (false) {

                        //associatedTerms
                        var payload = {
                            iterations: 5,
                            getAssociatedWords: 1,
                            indexName: index,
                            word: {ids: ids},
                            size: 20
                        };

                        $.ajax({
                            type: "POST",
                            url: elasticUrl,
                            data: payload,
                            dataType: "json",
                            success: function (data, textStatus, jqXHR) {
                                var dialogWordsSelect = "<select size='20' id='similarDocsAssociatedWords' multiple='multiple'>"
                                for (var i = 0; i < data.length; i++) {
                                    dialogWordsSelect += "<option value='" + data[i].key + "'>" + data[i].key + " (" + data[i].count + ")" + "</option>"
                                }
                                dialogWordsSelect += "</select><br>";
                                dialogWordsSelect += "<button  onclick='filterAssocatedDocs(true)'>filter</button>"

                                $("#dialogLeftDiv").html(dialogWordsSelect);

                                var xx = data;
                            }
                        })

                    }
                }

            })
        }

        function filterAssocatedDocs(withWords) {
            var index = $("#indexInput").val();


            var payload = {
                findDocumentsById: 1,
                indexName: index,
                ids: currentAssociatedDocIds,

            }
            if (withWords) {
                var words = $("#similarDocsAssociatedWords").val();
                payload.words = words;
            }

            $.ajax({
                type: "POST",
                url: elasticUrl,
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var html = "<table border='1'><tr><td>title</td><td>content</td></tr>";
                    var data = data.docs;
                    for (var i = 0; i < data.length; i++) {
                        var content = "<ul>";

                        for (var j = 0; j < data[i].highlights.length; j++) {
                            content += "<li>" + data[i].highlights[j] + "</li>"
                        }
                        content += "</ul>";
                        var title = data[i].title;

                        var score = data[i]._score;
                        html += "<tr>";
                        html += "<td>" + title + "</td><td>" + content + "</td>";
                        html += "</tr>";
                    }

                    html += "</table>";
                    $("#dialogContentDiv").html(html);
                    var xx = data;
                }
            });

        }

        function editMongoForm(mongoId, elasticId) {
            var url = "./form.html";
            $("#dialogLeftDiv").css("visibility", "hidden");
            $("#dialogContentDiv").load(url, function () {

                loadFormDataFromMongo(mode.dbName, mode.collectionName, mongoId, elasticId)

            })
        }

        function closeDialog() {
            $("#dialogContentDiv").html("");
            $("#dialog").css("visibility", "hidden")
        }

        function showMongoForm() {
            var url = "./form.html";
            $("#dialogLeftDiv").css("visibility", "hidden");
            $("#dialogContentDiv").load(url, function () {
                displayNewForm();
                $("#dialog").css("visibility", "visible")

            })

        }

        function toCsv() {
            search(0, 0, 0, function (err, data) {
                var csvFields = data.csvFields;
                data = data.docs;
                var str = "";
                if (data.length == 0)
                    return;
                var keys = [];
                if (csvFields && csvFields.length > 0) {
                    keys = csvFields;
                }
                else {
                    for (var i = 0; i < data.length; i++) {
                        for (var key in data[i]) {
                            if (keys.indexOf(key) < 0) {
                                if (key != "content") {
                                    keys.push(key);
                                }
                            }

                        }

                    }
                }
                for (var j = 0; j < keys.length; j++) {
                    str += keys[j] + ";"

                }
                str += "\n";

                for (var i = 0; i < data.length; i++) {
                    for (var j = 0; j < keys.length; j++) {
                        var value = data[i][keys[j]];
                        if (!value || value == "undefined")
                            value = "";
                        str += ("" + value).replace(/[\n\r\;]/g, ".") + ";"
                    }
                    str += "\n";
                }

                var name = $("#searchInput").val();
                fileName = "souslesensSearch_" + name + ".csv";

                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,'
                    + encodeURIComponent(str));
                element.setAttribute('download', fileName);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);


            })
        }

        function isFieldQuery() {
            var field = $("#queryFieldSelect").val();
            if (!field || field == "")
                return false;
            return true;
        }


        function scrollToHighlight(amount) {
            currentDocHighlightIndex += amount;
            if (currentDocHighlightIndex > 0)
                $("#scrollToHighlightUpButton").css("visibility", "visible");
            else
                $("#scrollToHighlightUpButton").css("visibility", "hidden");
            var h = $("#dialogContentDiv").height() / 2
            var z = $("#em_" + (currentDocHighlightIndex - 1)).offset().top;
            z -= h;
            z = dialogContentDivScroll + (z);
            $("#dialogContentDiv").animate({scrollTop: (z)}, 500);
            dialogContentDivScroll = z

        }

        function scrollToFindWord(word, amount) {

            if (currentDocFindWordIndex > 100)
                $("#scrollToWordUpButton").css("visibility", "visible");
            else
                $("#scrollToWordUpButton").css("visibility", "hidden");

            var text = $("#dialogContentDiv").html();


            // remove selected word em
            var text = $("#dialogContentDiv").html();
            //    text = text.replace(/wordEmSelected/gm, "wordEm");
            //  var p = text.indexOf("wordEmSelected");


            // remove all word em if change word
            var strEm = '<em class="wordEm">';
            if (word != currentFindWord.str) {


                text = text.replace(/<em.* class="wordEm">.*<\/em>/, currentFindWord.str);
                text = text.replace(/<\/em>/, "");
                currentFindWord.str = word;
                currentFindWord.p = 0;
                //set new word ems
                var regex = new RegExp(word, "gmi");
                var text = text.replace(regex, strEm + word + "</em>");

            }

            $("#dialogContentDiv").html(text);


            // set selected em
            var p = text.indexOf("wordEmSelected", currentFindWord.p);
            if (p < 0)
                p = 0;
            p = currentFindWord.p + p + strEm.length;
            currentFindWord.p = p;
            var strEmSelected = '<em class="wordEm wordEmSelected">' + word + "</em>";
            text = text.substring(0, p) + strEmSelected + text.substring(p + strEmSelected.length)
            $("#dialogContentDiv").html(text);


            var z = $(".wordEmSelected").offset().top;
            var h = $("#dialogContentDiv").height() / 2
            z -= h;
            z = dialogContentDivScroll + (z);
            $("#dialogContentDiv").animate({scrollTop: (z)}, 500);
            dialogContentDivScroll = z


        }

        function clearSearchInputs() {
            associatedWords = [];
            $("#searchInput").val("");
            $("#associatedWordsBreadcrumbDiv").val("");
            $("#associatedWordsDiv").html("");
            $("#leftPanel").css("visibility", "hidden")
            $("#infos").html("");
            $("#resultDiv").html("");
            $("#typesDiv").html("");
            $("#classifiersDiv").html("");


        }

        function showIndexesStats(data) {
            var indexesCxbs = "<ul>";
            for (var i = 0; i < data.length; i++) {
                var str =  "<button class='indexCbxButton' onclick='filterIndex(\"" + data[i].key + "\")'>O</button>"+data[i].key + " (" + data[i].count + ")"
                $("#indexCbxSpan_" + data[i].key).html(str);
                //  indexesCxbs += "<li><input type='checkbox' checked='checked' name='indexesCbxes' value='" + data[i].key + "'>" + data[i].key+" ("+ data[i].count+")</li>"
            }
            //    indexesCxbs += "<ul>";
            //  $("#sourcesDiv").html(indexesCxbs);

        }

        function filterIndex(index0) {
            $('[name=indexesCbxes]').each(function () {
                var index = $(this).val();
                if (index != index0)
                    $(this).prop('checked', false);
                else
                    $(this).prop('checked', "checked");
            });
            search();
        }


    </script>


</head>
<body>

<div id="panels">


    <div id="leftPanel" style="visibility: hidden">
        Associated words<br>
        filter
        <select id="associatedWordsFilter" onchange="getAssociatedWords()">
            <option value="allwords" selected="selected">low</option>
            </optionvalue>
            <option value="lemmes">medium</option>
            <option value="wordnetEntities">high</option>
            <!--  <option>googleEntities</option>-->
        </select>
        <div id="associatedWordsDiv"></div>

    </div>
    <div id="centerPanel" style="max-width: 600px;min-width: 300px">
        <div id="top">
            <table>

                <tr>

                    <td valign="middle">
                        <input type="hidden" id="indexInput" value="jfm" size="6">
                        <span id="queryFieldSpan" style="visibility:hidden"><select
                                id="queryFieldSelect"></select></span>
                    </td>
                    <td valign="middle">
                        <input id="searchInput" fetchSize="40" onkeydown="if (event.keyCode == 13)
                        document.getElementById('searchButton').click()">
                        &nbsp;
                        <button id="searchButton" onclick="search()">Search</button>
                        <!--  <input type="image" title="search" height="30px"
                                 onclick="search();" id="searchInputsImg"
                                 src="icons/search.png"/>-->
                        <input style="visibility: hidden;" type="image" align="middle" title="erase" height="20px"
                               onclick="clearSearchInputs();" id="clearSearchInputsImg"
                               src="icons/erase.png"/>
                    </td>
                    <td valign="middle">


                    </td>
                </tr>
                <tr>

                    <td>

                    </td>
                    <td>
                        <span id="plusSpan" style="visibility: hidden;">
                               <input type="image" align="middle" title="erase" height="20px"
                                      onclick="$('#subQuerySpan').css('visibility','visible');  $('#plusSpan').css('visibility', 'hidden')"
                                      id="plusImg"
                                      src="icons/plus.png"/>


                        </span>
                        <span id="subQuerySpan">
                            <select id="booleanSearchSelect">
                            <option value="and">And</option>
                             <option value="or">Or</option>
                        </select> &nbsp;

                            <input id="addWordInput" onkeydown="if (event.keyCode == 13)
                        document.getElementById('searchButton').click()">
                        </span>&nbsp;

                        <span id="slopSpan"> &nbsp; words proximity <input id="slopInput" size="5"></span>

                        <!--   <button id="showMongoFormInput" onclick="showMongoForm()">Create</button>-->
                    </td>
                </tr>

            </table>

        </div>
        <br>
        <div id="infos" style="visibility: hidden"><span id="countDiv"></span><span id="pages"></span> <img
                title='export csv' onclick='toCsv()' src='./icons/csv.png' width='20px'> </a></div>
        <br>


        <div id="associatedWordsBreadcrumbDiv"></div>


        <div id="resultDiv"></div>
        <!--   <div id="graphDiv"></div>-->

    </div>


    <div id="rightPanel">
        <table>
            <tr>
                <td>
                    sources<br>
                    <div id="sourcesDiv"></div>
                </td>
            </tr>
            <!--   <tr class="rightPanelTd">
                   <td>
                       types<br>
                       <div id="typesDiv"></div>
                   </td>
               </tr>-->
            <tr class="rightPanelTd">
                <td>
                    <div id="classifiersDiv">
                        classifierSource <select id="classifierSource" onchange="search()">
                        <option></option>
                        <option>custom</option>
                        <option>BNF</option>
                        <option>DBPEDIA</option>
                        <option>GoogleNLP</option>

                        <option>unesco</option>
                        <option>PLM</option>
                    </select>

                        <div id="conceptDiv"></div>
                    </div>
                </td>
            </tr>

        </table>


    </div>


</div>
<div id="dialog"><br>
    <table>
        <tr>
            <td>
                <button onclick='closeDialog()'>X</button>

            </td>

            <!--   <td>

                   <button onclick='findSimilarDocuments()'> similar Docs</button>

                   <br>
               </td>-->

            <td>
                &nbsp;
                <button onclick='scrollToHighlight(-1)' id="scrollToHighlightUpButton" style="visibility: hidden">
                    <
                </button>
                <b><span class="em">relevant passages</span></b>


                <button onclick='scrollToHighlight(+1)'> ></button>


            </td>
            <!--     <td>
                     &nbsp; &nbsp;


                     <button onclick='scrollToFindWord($("#searchWordInPrevisuButton").val(),-1)'
                             id="scrollToWordUpButton" style="visibility: hidden"> <
                     </button>

                     <span class="wordEm">find word</span> <input id="searchWordInPrevisuButton" onkeydown="if (event.keyCode == 13)
                         document.getElementById('scrollToWordDownButton').click()">


                     <button onclick='scrollToFindWord($("#searchWordInPrevisuButton").val(),+1)'
                             id="scrollToWordDownButton"> >
                     </button>

                     <!-- -->
            <!-- <button onclick='nexHighlight()'> >></button>-->
            </td>-->


            <td>
                <div id="dialogLeftDiv"></div>
                <!--  <button onclick='$("#dialog").css("visibility","hidden")'>X</button>-->
            </td>
        </tr>


    </table>


    <div id="dialogContentDiv"></div>
</div>
<div id="loginDiv" style="position: absolute;top:200px;left: 200px;visibility: hidden">
    login<input id="loginInput">
    password<input type="password" id="passwordInput" onkeydown="if (event.keyCode == 13)
                        document.getElementById('loginButton').click()">
    <button id="loginButton" onclick="doLogin()">OK</button>
    <div id="loginMessage"></div>
</div>


</body>
</html>