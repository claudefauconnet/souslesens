<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search</title>

    <style>
        body {
            font-family: verdana, sans-serif;
        }

        em {
            background-color: #dad55e;
        }

        em2 {
            background-color: #777620;
        }

        .title {
            font-weight: bold;
            color: blue;

        }

        #searchInput {
            height: 20px;
            width: 300px;
            font-size: 18px;
            font-weight: normal;
        }

        .path {
            color: blue;
        }

        .date {
            font-style: italic;
        }

        #panels {

        / / display: inline-table;
        }

        #leftPanel {
            width: 200px;
            float: left;
            overflow-y: auto;
            font-size: 12px;

        }

        #centerPanel {
            width: 600px;
            float: left;
            overflow-y: auto;
            font-size: 12px;

        }

        #rightPanel {
            width: 200px;
            float: left;

            overflow-y: auto;
            font-size: 10px;
        }

        #dialogContentDiv {
            width: 800px;
            height: 600px;
            overflow: auto;
            background-color: #eeeeee;
            font-size: 12px;
            font-weight: normal;
        }

        highlight {
            font-size: 10px;
        }

        #dialog {
            /*   position: absolute;
               top:200px;
               left:300px;*/
            display: flex;
        / / justify-content: center;
            align-items: center;
            position: absolute;
            height: 650px;
            width: 850px;
            top: 100px;
            left: 300px;
            background-color: #b3b6c2;
            visibility: hidden;
        }

        #associatedWordsBreadcrumbDiv {
            font-style: italic;
            font-weight: bold;
            color: brown;
        }

        img {
            vertical-align: middle;
        }

        #top {
            font-size: 14px;
        }

        .currentPageLink {
            font-weight: bold;
        }

        /*  .jstree-classic li[rel="Role"] > a {

              font-family: "sans-serif Verdana";
              font-size: 10px;
          }*/
    </style>

    <script src="../../common/js/jquery/jquery.min.js"></script>
    <script src="../../common/js/jquery/jquery-ui.min.js"></script>
    <script src="../../common/js/jsTree/jstree.min.js"></script>
    <script src="../../common/js/common.js"></script>
    <script src="../../common/js/jsTreeController.js"></script>
    <link rel="stylesheet" href="../../common/js/jsTree/themes/default/style.min.css"/>
    <script>
        var associatedWords = [];
        var oldWord = "";
        var currentClassifierData = [];
        var from0 = 0;
        var currentPage = 1;
        var currentDocId;
        var currentAssociatedDocIds;
        fetchSize = 10;

        $(function () {
            totalWidth = $(window).width();
            totalHeight = $(window).height();
            $("#centerPanel").width(Math.max(totalWidth - 500, 500));
            $("#centerPanel").height(totalHeight);
            $("#leftPanel").height(totalHeight);
            $("#rightPanel").height(totalHeight);
            $("#dialog").css("left", ((totalWidth) / 2) - 400)


            if (queryParams.index) {
                $("#indexInput").val(queryParams.index);

            }

            /*  $("#dialog").dialog({
             autoOpen: false,
             height: "650px",
             width: "850px",
             modal: true,



             });*/

            document.getElementById("searchInput").focus();
            $("#dialog").on("blur", function () {
                $("#dialog").css("visibility", "hidden")
            });
        })


        function search(_from, pageIncrement, page) {
            var from;
            if (!_from) {
                from = 0;
                currentPage = 1
            }
            else {
                from = _from;
                if (page)
                    currentPage = page;
                if (pageIncrement)
                    currentPage += pageIncrement;
            }

            $("#dialog").css("visibility", "hidden")
            $("#conceptDiv").html("");
            $("#countDiv").html("");
            $("#resultDiv").html("");
            $("#leftPanel").html("");


            var index = $("#indexInput").val();
            var word = $("#searchInput").val();
            if (word != oldWord) {
                associatedWords = []
            }
            oldWord = word;
            var slop = $("#slopInput").val();

            var payload = {
                findDocuments: 1,
                from: from,
                fetchSize: fetchSize,
                indexName: index,
                withClassifier: true,
                word: word
            };
            if (slop != "")
                payload.slop = parseInt(slop);
            if (associatedWords.length > 0)
                payload.andWords = associatedWords;


            $.ajax({
                type: "POST",
                url: "/elastic",
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var xxx = data;
                    showResults(data.docs);
                    showClassifier(data.classifier);
                    showPageControls(data.total);

                }
                , error: function (xhr, err, msg) {
                    return (err);
                }

            });

            /*----------------associated words********************************/
            var payload = {
                getAssociatedWords: 1,
                indexName: index,
                word: word,
                size: 100
            };
            if (slop != "")
                payload.slop = parseInt(slop);
            if (associatedWords.length > 0)
                payload.andWords = associatedWords;

            $.ajax({
                type: "POST",
                url: "/elastic",
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var xxx = data;
                    showAssociatedWords(data);

                }
                , error: function (xhr, err, msg) {
                    return (err);
                }

            });
        }

        function showResults(data) {
            var html = "<table>";
            for (var i = 0; i < data.length; i++) {
                html += "<tr>";
                html += "<td>";
                html += getListDisplayHtml(data[i]);

                html += "</tr>";
                html += "</td>";
            }
            html += "</table>";


            $("#resultDiv").html(html);
        }
        function showPageControls(total) {
            var maxPagesLinks = 10;
            $("#countDiv").html(total + " documents found");
            if (total > fetchSize) {

                var str = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pages ";
                var k = 1

                str += "<a href='javascript:search(" + currentPage * fetchSize + ",1)'> next  </a>&nbsp;&nbsp;";
                if (currentPage > 1)
                    str += "<a href='javascript:search(" + (currentPage - 1) * fetchSize + ",-1)'> previous  </a>&nbsp;&nbsp;";


                for (var i = 1; i < total; i++) {
                    var linkClass = "";
                    if (k == currentPage)
                        linkClass = " class='currentPageLink' ";


                    if (i % fetchSize == 0) {
                        str += "<a " + linkClass + "href='javascript:search(" + (k - 1) * fetchSize + ",0," + k + ")'>" + k + "</a>&nbsp;&nbsp;"
                        k++;
                    }

                    /*  if (currentPage > 1) {
                     str += "<a href='javascript:search(" + 0 + ",1)'>...first  </a>&nbsp;&nbsp;";

                     }*/

                    if (i > maxPagesLinks * fetchSize) {
                        str += "...";
                        // str += "<a href='javascript:search(" +Math.round(total/fetchSize)*fetchSize + ")'>... first </a>&nbsp;&nbsp;";
                        break;
                    }
                }


                $("#pages").html(str)
            }
        }


        function showAssociatedWords(data) {
            var html = "<ul>"
            data.sort(function (a, b) {
                if (a.count > b.count)
                    return -1;
                if (a.count < b.count)
                    return 1;
                return 0
            })
            for (var i = 0; i < data.length; i++) {
                if (data[i].key.length > 3)
                    html += "<li>" + "<a href='javascript:addAssociatedWord(\"" + data[i].key + "\")'>" + data[i].key + " (" + data[i].count + ")</a></li>"
            }
            html += "</ul>";
            $("#leftPanel").html("<br><br><br><br><br>Mots associes<br>" + html);

        }

        function getListDisplayHtml(obj) {
            var str = "";
            str += "<span class=title>" + obj.title + "</span>&nbsp;&nbsp;<span class=date>" + obj.date + "</span>&nbsp;&nbsp;";
            str += "<img  title='pre-visualize' onclick='visualizeDocContent(\"" + obj._id + "\")' src='view.png' width='15px'> </a>";
            str += "<img title='go to document' onclick='openDocument(\"" + obj.path + "\")' src='document.png' width='15px'> </a><br>";
            // str += "<span class=path>" + obj.path + "</span><br>";

            str += "<ul>";
            for (var i = 0; i < obj.highlights.length; i++) {

                str += "<li><span class=highlight>" + obj.highlights[i] + "</span></li>";

            }
            str += "</ul>";

            return str;
        }


        function addAssociatedWord(word) {
            associatedWords.push(word);
            showAssociatedWordsBreadcrumb();
            search();


        }


        function showAssociatedWordsBreadcrumb() {
            var str = "";
            for (var i = 0; i < associatedWords.length; i++) {
                str += "<a href='javascript:removeAssociatedWord(" + i + ")'>" + associatedWords[i] + "</a>&nbsp;";
            }
            $("#associatedWordsBreadcrumbDiv").html(str)

        }

        function removeAssociatedWord(index) {

            associatedWords.splice(index, 1);
            showAssociatedWordsBreadcrumb();
            search();
        }

        function showClassifier(data) {

            $('#rightPanel').html("<br><br><br><br><br><br><br><br>Concepts associes<br><br> <div id='conceptDiv'></div>")
            currentClassifierData = data


            jsTreeController.load(data, 'conceptDiv', function ( node) {

                if (node.children.length > 0) {
                    for (var i = 0; i < currentClassifierData.length; i++) {
                        if (currentClassifierData[i].text == node.text) {
                            for (var j = 0; j < currentClassifierData[i].children.length; j++) {
                                addAssociatedWord( currentClassifierData[i].children[j].word);
                            }
                        }
                    }
                } else {
                    var word = node.original.word;

                   addAssociatedWord(word);
                }



            });


        }

        function visualizeDocContent(id) {
            $("#dialogLeftDiv").html("");
            currentDocId = id;
            var index = $("#indexInput").val();
            var words = associatedWords;
            words.push($("#searchInput").val());

            var payload = {
                findDocumentsById: 1,
                indexName: index,
                ids: [id],
                words: words
            };


            $.ajax({
                type: "POST",
                url: "/elastic",
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {

                    if (data.docs && data.docs.length > 0) {
                        var doc = data.docs[0];

                        for (var i = 0; i < doc.highlights.length; i++) {
                            var highlight = doc.highlights[i];
                            var highlight2 = highlight.replace(/<em>/g, "");
                            highlight2 = highlight2.replace(/<\/em>/g, "");
                            highlight = highlight.replace(/<em>/g, "<b>");
                            highlight = highlight.replace(/<\/em>/g, "</b>");
                            var p = doc.content.indexOf(highlight2);
                            if (p > -1) {
                                //   doc.content=doc.content.substring(0,p)+"<em>"+doc.content.substring(p+1,p+1+highlight.length)+"</em>"+doc.content.substring(p+1)
                                doc.content = doc.content.substring(0, p) + "<em>" + highlight + "</em>" + doc.content.substring(p + 1 + highlight.length)
                            }

                        }
                        var html = "<b>title</b>: " + doc.title + "<br>";
                        html += doc.content.replace(/[\n\r]/g, "<br>");

                        $("#dialogContentDiv").html(html);
                        $("#dialog").css("visibility", "visible");


                    }
                }
                , error: function (xhr, err, msg) {
                    return (err);
                }

            });
        }

        function openDocument(path) {
            window.location.href = "file:///" + path;

        }

        function admin() {
            var html = "<button onclick='saveClassifier()'>save</button><br></button><div id='adminClassifierTree'></div>";
            $("#dialogContentDiv").html(html);
            $("#dialog").css("visibility", "visible");
            /*       adminClassifierTree.load(data, 'conceptDiv', function (functionName, data) {
             if (functionName == "addAssociatedWord")
             addAssociatedWord(data);

             });*/
        }

        function findSimilarDocuments() {
            var index = $("#indexInput").val();
            var payload = {
                findSimilarDocuments: 1,
                indexName: index,
                docId: currentDocId,
                minScore: 3,
                size: 100
            };


            $.ajax({
                type: "POST",
                url: "/elastic",
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var ids = [];
                    var html = "<table border='1'><tr><td>score</td><td>title</td><td>content</td></tr>";
                    for (var i = 0; i < data.length; i++) {
                        ids.push(data[i]._id);
                        var title = data[i].title;
                        var content = data[i].content;
                        var score = data[i]._score;
                        html += "<tr>";
                        html += "<td>" + score + "</td><td>" + title + "</td><td>" + content + "</td>";
                        html += "</tr>";
                    }
                    currentAssociatedDocIds = ids;
                    html += "</table>";
                    $("#dialogContentDiv").html(html);

                    //associatedTerms
                    var payload = {
                        getAssociatedWords: 1,
                        indexName: index,
                        word: {ids: ids},
                        size: 20
                    };

                    $.ajax({
                        type: "POST",
                        url: "/elastic",
                        data: payload,
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            var dialogWordsSelect = "<select size='20' id='similarDocsAssociatedWords' multiple='multiple'>"
                            for (var i = 0; i < data.length; i++) {
                                dialogWordsSelect += "<option value='" + data[i].key + "'>" + data[i].key + " (" + data[i].count + ")" + "</option>"
                            }
                            dialogWordsSelect += "</select><br>";
                            dialogWordsSelect += "<button  onclick='filterAssocatedDocs()'>filter</button>"

                            $("#dialogLeftDiv").html(dialogWordsSelect);

                            var xx = data;
                        }
                    })


                }

            })
        }

        function filterAssocatedDocs() {
            var index = $("#indexInput").val();

            var words = $("#similarDocsAssociatedWords").val();
            var payload = {
                findDocumentsById: 1,
                indexName: index,
                ids: currentAssociatedDocIds,
                words: words
            }

            $.ajax({
                type: "POST",
                url: "/elastic",
                data: payload,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    var html = "<table border='1'><tr><td>title</td><td>content</td></tr>";
                    var data=data.docs;
                    for (var i = 0; i < data.length; i++) {
                        var content = "<ul>";

                        for (var j = 0; j < data[i].highlights.length; j++) {
                            content += "<li>" + data[i].highlights[j] + "</li>"
                        }
                        content += "</ul>";
                        var title = data[i].title;

                        var score = data[i]._score;
                        html += "<tr>";
                        html += "<td>" + title + "</td><td>" + content + "</td>";
                        html += "</tr>";
                    }

                    html += "</table>";
                    $("#dialogContentDiv").html(html);
                    var xx = data;
                }
            });

        }
    </script>


</head>
<body>

<div id="panels">


    <div id="leftPanel">


    </div>
    <div id="centerPanel">
        <div id="top">
            index <input id="indexInput" value="jfm" size="6">&nbsp;words
            <input id="searchInput" fetchSize="40" onkeydown="if (event.keyCode == 13)
                        document.getElementById('searchButton').click()">
            &nbsp;
            <button id="searchButton" onclick="search()">Search</button>
            &nbsp;words distance <input id="slopInput" size="2"> &nbsp&nbsp;
            <button onclick='admin()'>admin</button>

        </div>
        <br>
        <div id="infos"><span id="countDiv"></span><span id="pages"></span></div>
        <br>
        <div id="associatedWordsBreadcrumbDiv"></div>

        <hr>

        <div id="resultDiv"></div>


    </div>


    <div id="rightPanel"><br><br><br><br><br>
        <div id="conceptDiv"></div>
    </div>
    <div id="dialog"><br>
        <table>
            <tr>
                <td>
                    <button onclick='$("#dialog").css("visibility","hidden")'>X</button>
                </td>
            </tr>
            <tr>
                <td>

                    <button onclick='findSimilarDocuments()'> similar Docs</button>
                    <!-- <button onclick='nexHighlight()'> >></button>-->
                    <br>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="dialogLeftDiv"></div>
                    <!--  <button onclick='$("#dialog").css("visibility","hidden")'>X</button>-->
                </td>
            </tr>

        </table>


        <div id="dialogContentDiv"></div>
    </div>

</div>


</body>
</html>